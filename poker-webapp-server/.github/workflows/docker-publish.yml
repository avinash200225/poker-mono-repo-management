name: Build, Publish Docker Build && Notify

on:
  push:
    branches: ["dev"]   # Trigger workflow only on pushes to dev branch

permissions:
  contents: write       # Required to push tags back to the repository

jobs:
  build-and-notify:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository with full history (needed for tags)
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # Fetch full history including tags

      # Step 2: Set build metadata (timestamp, date, version) and push new version tag
      - name: Set TIMESTAMP, DATE & VERSION
        id: version
        run: |
          # Set timezone to IST
          export TZ='Asia/Kolkata'

          # Generate timestamp for unique Docker image tag
          echo "TIMESTAMP=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV

          # Human-readable date for email notifications
          echo "DATE=$(date '+%d %b %Y %I:%M %p')" >> $GITHUB_ENV

          # Get latest Git tag, default to 1.0.0 if none exists
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "1.0.0")
          echo "Latest tag: $latest_tag"

          # Increment patch version (major.minor.patch)
          IFS='.' read -r major minor patch <<< "$latest_tag"
          patch=$((patch+1))
          VERSION="$major.$minor.$patch"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # Configure Git user and push new version tag
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -a "$VERSION" -m "CI: Auto Release $VERSION"
          git push origin "$VERSION"

      # Step 3: Log in to Docker Hub
      - name: Log in to Wildace Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME_WILDACE }}
          password: ${{ secrets.DOCKERHUB_TOKEN_WILDACE }}

      # Step 4: Build Docker image and capture logs
      - name: Build Docker Image
        run: |
          mkdir -p logs
          # Build Docker image with version and timestamp for uniqueness
          docker build . --file Dockerfile --tag wildace/poker-webapp-server:${{ env.VERSION }}-${{ env.TIMESTAMP }} | tee logs/build.log
          # Tag same image as version-only (for email notification)
          docker tag wildace/poker-webapp-server:${{ env.VERSION }}-${{ env.TIMESTAMP }} wildace/poker-webapp-server:${{ env.VERSION }}
          # Tag latest for convenience
          docker tag wildace/poker-webapp-server:${{ env.VERSION }}-${{ env.TIMESTAMP }} wildace/poker-webapp-server:latest

      # Step 5: Push Docker images to Docker Hub
      - name: Push Docker Image
        run: |
          docker push wildace/poker-webapp-server:${{ env.VERSION }}-${{ env.TIMESTAMP }} | tee -a logs/build.log
          docker push wildace/poker-webapp-server:${{ env.VERSION }} | tee -a logs/build.log
          docker push wildace/poker-webapp-server:latest | tee -a logs/build.log

      # Step 6: Configure AWS credentials for S3 + SES
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      # Step 7: Upload build log to S3
      - name: Upload Build Log to S3
        run: |
          aws s3 cp logs/build.log s3://only-unity-build/dev/poker-webapp-server/latest-build.log

      # Step 8: Send email notification with build details
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: email-smtp.ap-south-1.amazonaws.com
          server_port: 465
          secure: true
          username: ${{ secrets.SES_USER }}
          password: ${{ secrets.SES_PASS }}
          from: Monika <monika@wildace.in>
          to: |
            monika@wildace.in
            naveen@wildace.in
          # Subject updated to your requested format
          subject: poker-webapp-server:${{ env.VERSION }} version ${{ env.DATE }}
          # Email body shows Docker image with version only (no timestamp)
          body: |
            Docker Image: docker.io/wildace/poker-webapp-server:${{ env.VERSION }}
            Build Log: https://only-unity-build.s3.ap-south-1.amazonaws.com/dev/poker-webapp-server/latest-build.log
          attachments: logs/build.log
